"""
=================================================================
   ThreatTrace â€” Email Alerting System (Flask-Mail)
=================================================================

Provides two alert email channels:

1ï¸âƒ£ send_tamper_email()
    â†’ Used by audit_service when file-integrity changes

2ï¸âƒ£ send_security_email()
    â†’ Used by unified alert_manager for high/critical alerts

Both functions:
    âœ“ Support HTML + plain text fallback
    âœ“ Auto-detect mail instance
    âœ“ Auto-detect admin recipient
"""

from flask_mail import Message
from flask import current_app


# -------------------------------------------------------------
# INTERNAL HELPERS
# -------------------------------------------------------------
def _get_mail_instance():
    """Safely return Flask-Mail instance or None."""
    mail = current_app.extensions.get("mail")
    if not mail:
        print("âŒ Flask-Mail not initialized â€” email alerts disabled")
        return None
    return mail


def _get_recipients():
    """Get admin email(s). Must exist in config MAIL_USERNAME."""
    admin = current_app.config.get("MAIL_USERNAME")
    if not admin:
        print("âš  No MAIL_USERNAME configured â€” cannot send email alerts")
        return []
    return [admin]


# -------------------------------------------------------------
# 1ï¸âƒ£ SEND TAMPER ALERT EMAIL
# -------------------------------------------------------------
def send_tamper_email(file_path, hash_value, timestamp, severity="HIGH"):
    """
    Triggered when audit_service detects file tampering.
    """
    mail = _get_mail_instance()
    recipients = _get_recipients()
    if not mail or not recipients:
        return

    sender = current_app.config.get("MAIL_USERNAME")

    subject = f"ğŸš¨ ThreatTrace TAMPER ALERT â€” {severity}"

    msg = Message(subject=subject, sender=sender, recipients=recipients)

    # Plain text
    msg.body = f"""
A tampering event was detected.

File Path : {file_path}
SHA256    : {hash_value}
Timestamp : {timestamp}
Severity  : {severity}

Recommended:
â€¢ Review audit logs
â€¢ Verify system user actions
â€¢ Check server integrity
â€¢ Investigate for ransomware traces

â€” ThreatTrace Security Engine
"""

    # HTML version
    msg.html = f"""
<h2 style="color:#ff4444;">ğŸš¨ ThreatTrace â€” Tampering Alert</h2>

<p>A monitored system file has changed unexpectedly.</p>

<ul>
  <li><strong>File Path:</strong> {file_path}</li>
  <li><strong>SHA256 Hash:</strong> {hash_value}</li>
  <li><strong>Timestamp:</strong> {timestamp}</li>
  <li><strong>Severity:</strong> {severity}</li>
</ul>

<h3>Recommended Actions:</h3>
<ul>
  <li>Check ThreatTrace audit logs</li>
  <li>Investigate administrator or process activity</li>
  <li>Check for encryption (possible ransomware)</li>
</ul>

<p style="color:gray;">ThreatTrace â€” Automated Security Monitoring System</p>
"""

    try:
        mail.send(msg)
        print(f"ğŸ“§ Tamper alert email sent â†’ {file_path}")
    except Exception as e:
        print(f"âŒ Failed to send tamper alert email: {e}")


# -------------------------------------------------------------
# 2ï¸âƒ£ SEND SECURITY EMAIL (Used by send_alert)
# -------------------------------------------------------------
def send_security_email(title, message):
    """
    Used for high/critical alerts from unified alert manager.
    """
    mail = _get_mail_instance()
    recipients = _get_recipients()
    if not mail or not recipients:
        return

    sender = current_app.config.get("MAIL_USERNAME")

    msg = Message(
        subject=f"ğŸ”´ Security Alert â€” {title}",
        sender=sender,
        recipients=recipients,
    )

    msg.body = f"""
A high-severity alert has been raised.

Title   : {title}
Message : {message}

Time    : {current_app.config.get("TIMEZONE", "UTC")}

â€” ThreatTrace Security Engine
"""

    msg.html = f"""
<h2 style="color:#d9534f;">ğŸ”´ ThreatTrace â€” High Severity Alert</h2>

<p><strong>{title}</strong></p>
<p>{message}</p>

<p style="margin-top:20px;color:gray;">
This message was automatically generated by the ThreatTrace Security Engine.
</p>
"""

    try:
        mail.send(msg)
        print(f"ğŸ“§ Security email sent â†’ {title}")
    except Exception as e:
        print(f"âŒ Failed to send security alert email: {e}")
